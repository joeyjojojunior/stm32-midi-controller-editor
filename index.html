<style>
    body {

        background-color: black;
    }

    .mainDiv {
        width: 100%;
        display: inline-flex;
        justify-content: center;
    }


    .container {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        overflow: auto;
    }

    .editDiv {
        display: inline-flex;
        flex-direction: row;
        align-items: flex-start;
        font-size: 16;
        background-color: black;
        padding-bottom: 15px;
    }

    table {
        font-size: 14;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #C0C0C0;
    }

    thead {
        font-weight: bold;
        font-size: 24;
        color: #A7C7E7;
    }

    td {
        white-space: nowrap;
        display: flex;
        align-items: center;
    }

    .inputField {
        width: 125px;
        border-radius: 2px;
        border: none;
    }

    .listDivSublabels {
        margin-top: 38px;
        margin-left: 5px;
    }

    .listDivSublabelsLabel {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14;
        padding-bottom: 2px;
        background-color: black;
        color: #C0C0C0;
    }

    .listSublabels {
        display: inline-flex;
        flex-direction: column;
        flex-wrap: wrap;
        list-style-type: none;
        height: 285px;
        padding: 0px;
        margin: 0 auto;

    }

    .listSublabelItem {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14;

        background-color: #202020;
        border: 1px solid black;
        color: #C0C0C0;
        padding-left: 15px;
        padding-right: 15px;
        padding-top: 2px;
        padding-bottom: 2px;
        margin-top: 1px;
        margin-bottom: 1px;
        margin-right: 3px;
        margin: 0px;
        white-space: nowrap;

    }

    .grid {
        position: relative;
        display: inline-block;
    }


    .item {
        display: block;
        position: absolute;
        width: 108px;
        height: 54px;
        margin: 4px;
        z-index: 1;
        background: black;
        color: #C0C0C0;
        font-family: monospace;
        border: solid 1px #C0C0C0;
    }

    .item:hover {
        border: 1px solid red;
    }

    .item.item.muuri-item-dragging {
        border: 1px solid red;
    }

    .item.muuri-item-dragging {
        z-index: 3;
    }

    .item.muuri-item-releasing {
        z-index: 2;
    }

    .item.muuri-item-hidden {
        z-index: 0;
    }

    .item.mu .item-content {
        position: relative;
        width: 100%;
        height: 100%;
    }
</style>

<body>

    <head>
    </head>
    <div class="mainDiv">
        <div class="container">
            <div class="editDiv"></div>
            <div class="grid" id="knobGrid"></div>
        </div>
    </div>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="jquery.fittext.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-animations-js@2.3.2/web-animations.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/muuri@0.9.5/dist/muuri.min.js"></script>
</body>

<script>
    var MAX_LABEL_CHARS = 14;
    var MAX_SL_PER_COL = 12;
    var NUM_COLS = 16;
    var NUM_ROWS = 8;
    var NUM_KNOBS = 128;
    var currKnob = 0;
    var knobs = new Array(NUM_KNOBS);

    for (var i = 0; i < NUM_KNOBS; i++) {
        gridDiv = document.getElementById("knobGrid");

        gridItem = document.createElement("div");
        gridItem.className = "item";
        gridItem.id = `gridItem${i}`;
        gridItem.addEventListener("mouseup", eventClickGridItem, false);

        gridItemContent = document.createElement("div");
        gridItemContent.className = "item-content";
        gridItemContent.id = `gridItemContent${i}`;

        gridKnobContent = document.createElement("div");
        gridKnobContent.className = "knobContent";
        gridKnobContent.id = `knobContent${i}`;
        gridKnobContent.innerHTML += `${i + 1}<br>THIS IS 14 CHR`

        gridItemContent.appendChild(gridKnobContent);
        gridItem.appendChild(gridItemContent);

        knobs[i] = gridItem;
    }

    function createKnobDivSettings() {
        var editDiv = document.querySelector(".editDiv");

        for (var i = 0; i < NUM_KNOBS; i++) {
            var knobDivSettings = document.createElement("div");
            knobDivSettings.className = "knobDivSettings";
            knobDivSettings.id = `knobDivSettings${i}`;
            knobDivSettings.style.display = "none";
            knobDivSettings.appendChild(createKnobTableSettings(i));
            editDiv.appendChild(knobDivSettings);
            editDiv.appendChild(createKnobDivSublabels(i));
        }
    }

    function createKnobDivSublabels(knobID) {
        var listDivSublabels = document.createElement("div");
        listDivSublabels.className = "listDivSublabels";
        listDivSublabels.id = `listDivSublabels${knobID}`;

        var labelDiv = document.createElement("div");
        labelDiv.className = "listDivSublabelsLabel";
        labelDiv.innerHTML = "Sub Labels"

        var listSublabels = document.createElement("ul");
        listSublabels.className = "listSublabels";
        listSublabels.id = `listSublabels${knobID}`;

        var labels = new Array(Math.floor(Math.random() * (128 - 1 + 1)) + 1);
        //var labels = new Array(128);

        for (var i = 0; i < labels.length; i++) {
            var subLabel = document.createElement("li");
            subLabel.innerHTML += `Knob ${knobID} SBL ${i}`;
            subLabel.className = 'listSublabelItem'
            listSublabels.appendChild(subLabel);
        }

        var test = labels.length / MAX_SL_PER_COL;
        listSublabels.style.columnCount = Math.floor(labels.length / MAX_SL_PER_COL);

        listDivSublabels.appendChild(labelDiv);
        listDivSublabels.appendChild(listSublabels);
        listDivSublabels.style.display = "none";
        return listDivSublabels
    }

    function createKnobTableSettings(knobID) {
        var tbl = document.createElement("table");

        var thead = document.createElement("thead");
        var trHead = document.createElement("tr");
        var tdHead = document.createElement("td");
        tdHead.innerHTML += `Knob ${knobID + 1}`;
        tdHead.colSpan = "2";

        trHead.appendChild(tdHead);
        thead.appendChild(trHead);
        tbl.appendChild(thead);

        var tbdy = document.createElement("tbody");
        var inputLabels = ["Label", "Channel", "CC", "Init Value", "Max Values", "Max Range", "Locked"];
        var knobInputFields = createKnobInputFields(knobID);

        for (var i = 0; i < knobInputFields.length; i++) {
            var tr = document.createElement("tr");

            var tdInputLabel = document.createElement("td");
            tdInputLabel.innerHTML = inputLabels[i];

            var tdInputField = document.createElement("td");
            tdInputField.appendChild(knobInputFields[i]);

            tr.appendChild(tdInputLabel);
            tr.appendChild(tdInputField);
            tbdy.appendChild(tr);
        }

        tbl.appendChild(tbdy);

        return tbl;

    }

    function createKnobInputFields(knobID) {
        var label = document.createElement("input");
        var subLabels = document.createElement("select");
        var channel = document.createElement("input");
        var cc = document.createElement("input");
        var initValue = document.createElement("input");
        var maxValues = document.createElement("input");
        var maxRange = document.createElement("input");
        var isLocked = document.createElement("input");

        label.className = "inputField";
        label.id = `inputLabel${knobID}`;

        channel.className = `inputField`;
        channel.id = `inputChannel${knobID}`;

        cc.className = `inputField`;
        cc.id = `inputCC${knobID}`;

        initValue.className = `inputField`;
        initValue.id = `inputInitValue${knobID}`;

        maxValues.className = `inputField`;
        maxValues.id = `inputMaxValues${knobID}`;

        maxRange.className = `inputField`;
        maxRange.id = `inputMaxRange${knobID}`;

        isLocked.className = `inputField`;
        isLocked.id = `inputIsLocked${knobID}`;

        var inputs = [label, channel, cc, initValue, maxValues, maxRange, isLocked];

        for (var i = 0; i < inputs.length; i++) {
            inputs[i].maxLength = MAX_LABEL_CHARS;
        }

        return inputs;
    }

    function eventClickGridItem(e) {
        var editDiv = document.querySelector(".editDiv");
        var knobIDString = e.target.id;
        var knobID = (knobIDString.match(/\d+/g) || []).map(n => parseInt(n))[0];
        var knobDivSettings = document.getElementById(`knobDivSettings${knobID}`);
        var listDivSublabels = document.getElementById(`listDivSublabels${knobID}`);

        var sl = document.getElementById(`listSublabels${knobID}`);
        console.log(sl);

        if (!drag) {
            hideKnobDivSettingsAll();
            knobDivSettings.style.display = "block";
            listDivSublabels.style.display = "block";
        }
        currKnob = knobID;
    }

    function showKnobDivSettings(knobID) {
        var knobDivSettings = document.getElementById(`knobDivSettings${knobID}`);
        var listDivSublabels = document.getElementById(`listDivSublabels${knobID}`);

        knobDivSettings.style.display = "block";
        listDivSublabels.style.display = "block";
    }

    function hideKnobDivSettingsAll() {
        var knobDivSettingsAll = document.getElementsByClassName("knobDivSettings");
        var listDivSublabelsAll = document.getElementsByClassName("listDivSublabels");
        for (var i = 0; i < knobDivSettingsAll.length; i++) {
            knobDivSettingsAll[i].style.display = "none";
            listDivSublabelsAll[i].style.display = "none";
        }
    }

    var grid = new Muuri('.grid', {
        items: knobs,
        dragEnabled: true,
        dragSortHeuristics: {
            sortInterval: 200,
            minDragDistance: 20,
            minBounceBackAngle: 1
        },
        dragSortPredicate: {
            threshold: 50,
            action: 'swap',
            migrateAction: 'move'
        },
        layout: function (grid, layoutId, items, width, height, callback) {
            var layout = {
                id: layoutId,
                items: items,
                slots: [],
                styles: {},
            };

            // Calculate the slots asynchronously. Note that the timeout is here only
            // as an example and does not help at all in the calculations. You should
            // offload the calculations to web workers if you want real benefits.
            // Also note that doing asynchronous layout is completely optional and you
            // can call the callback function synchronously also.
            var timerId = window.setTimeout(function () {
                var item,
                    m,
                    x = 0,
                    y = 0,
                    w = 0,
                    h = 0;

                for (var i = 0; i < items.length; i++) {
                    item = items[i];
                    x += w;
                    if (i % NUM_COLS == 0) {
                        x = 0;
                        y += h;
                    }
                    m = item.getMargin();
                    w = item.getWidth() + m.left +
                        m.right;
                    h = item.getHeight() + m.top + m.bottom;
                    layout.slots.push(x, y);
                }
                w += x;
                h += y;

                // Set the CSS styles that should be applied to the grid element.
                layout.styles.width = w + 'px';
                layout.styles.height = h + 'px';

                // When the layout is fully computed let 's call the callback function and 
                // provide the layout object as it's argument.
                callback(layout);
            }, 200);

            // If you are doing an async layout you _can_ (if you want to) return a 
            // function that cancels this specific layout calculations if it 's still 
            // processing/queueing when the next layout is requested.
            return function () {
                window.clearTimeout(timerId);
            };
        },
    });

    let drag = false;
    document.addEventListener(
        'mousedown', () => drag = false);

    document.addEventListener(
        'mousemove', () => drag = true);

    document.addEventListener(
        'mouseup', () => drag ? 'drag' : 'click');

    createKnobDivSettings();
    showKnobDivSettings("0");

    // Keeps grid item text in its container
    jQuery(".knobContent").fitText(0.87);


    // Allows moving sub labels around
    $(function () {
        $(".listSublabels").sortable();
        $(".listSublabels").disableSelection();
    });
</script>